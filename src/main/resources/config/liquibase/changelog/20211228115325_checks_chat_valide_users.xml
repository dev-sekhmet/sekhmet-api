<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.1.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
    <changeSet author="gtemate" id="1640692423077-3" dbms="postgresql">
        <sql>
            <![CDATA[
            CREATE FUNCTION chat_greater_than_two_users()
                RETURNS BOOLEAN AS
            '
            BEGIN
                RETURN (
                    SELECT EXISTS(SELECT count(u.login) as nb_users, c.name, c.chat_type as type
                                  FROM skh_user u
                                           INNER JOIN chat_member cm on u.id = cm.user_id
                                           INNER JOIN chat c on c.id = cm.chat_id
                                  WHERE c.chat_type = ''GROUPE''
                                  GROUP BY c.name, type
                                  HAVING count(u.login) < 3
                                  ORDER BY c.name)
                );
            END;
            ' LANGUAGE plpgsql;


            CREATE FUNCTION chat_two_users()
                RETURNS BOOLEAN AS
            '
            BEGIN
                RETURN (
                    SELECT EXISTS(SELECT count(u.login) as nb_users, c.name, c.chat_type as type
                                  FROM skh_user u
                                           INNER JOIN chat_member cm on u.id = cm.user_id
                                           INNER JOIN chat c on c.id = cm.chat_id
                                  WHERE c.chat_type = ''TWO_USER''
                                  GROUP BY c.name, type
                                  HAVING count(u.login) <> 2
                                  ORDER BY c.name)
                );
            END;
            ' LANGUAGE plpgsql;

            alter table chat
                add constraint chat_two_users
                    CHECK (chat_two_users() = false);
            alter table chat
                add constraint chat_greater_than_two_users
                    CHECK (chat_greater_than_two_users() = false);
            ]]>
        </sql>
    </changeSet>
</databaseChangeLog>
